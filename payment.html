<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D‚Äôlia Ornaments PH | Payment</title>
  <link rel="stylesheet" href="styles/payment.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <link rel="icon" href="assets/home/logo.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script type="text/javascript">
    (function() {
      // REPLACE WITH YOUR ACTUAL PUBLIC KEY
      emailjs.init("9o4gmWYwJqh37ZBD4"); 
    })();
  </script>
</head>

<body>
  <main class="payment-container">
    <header class="payment-header">
      <h1 class="brand-title">D‚Äôlia Ornaments PH</h1>
      <nav class="breadcrumb">
        <a href="checkout.html">Information</a> ‚Ä∫ 
        <a href="shipping.html">Shipping</a> ‚Ä∫ 
        <strong>Payment</strong>
      </nav>
    </header>

    <div class="checkout-layout">
      <section class="left-section">
        <div class="info-cards">
          <div class="info-card">
            <div class="info-label">üìû Contact</div>
            <div class="info-details" id="contact-email">your@email.com</div>
            <a href="checkout.html" class="info-change">Change</a>
          </div>

          <div class="info-card">
            <div class="info-label">üìç Ship to</div>
            <div class="info-details" id="shipping-address">Your address here</div>
            <a href="shipping.html" class="info-change">Change</a>
          </div>
        </div>

        <h2>Payment Method</h2>
        <form id="payment-form">
          <label class="method-card">
            <input type="radio" name="payment" value="cod" checked>
            <div class="method-info">
              <div class="method-title">üíµ Cash on Delivery</div>
              <p class="method-desc">Available for <strong>Meetup Only</strong> Around Imus Area</p>
            </div>
            <div></div> 
          </label>

          <label class="method-card">
            <input type="radio" name="payment" value="gcash">
            <div class="method-info">
              <div class="method-title">üì± GCash</div>
              <p class="method-desc">GCash Account: <strong>09167424976</strong> KY**L RO*E P.</p>
            </div>
            <button type="button" class="qr-btn" onclick="openQR('gcash', event)">
              <i class="fas fa-qrcode"></i> View QR
            </button>
          </label>

          <label class="method-card">
            <input type="radio" name="payment" value="maya">
            <div class="method-info">
              <div class="method-title">üì± Maya</div>
              <p class="method-desc">Maya Account: <strong>09156006045</strong> Gabrielle Emmanuelle Marion</p>
            </div>
            <button type="button" class="qr-btn" onclick="openQR('maya', event)">
              <i class="fas fa-qrcode"></i> View QR
            </button>
          </label>

          <div class="form-actions">
            <a href="shipping.html" class="back-link">‚Üê Return to Shipping</a>
            <button type="submit" class="confirm-btn">Confirm Payment</button>
          </div>
        </form>
      </section>

      <aside class="right-section">
        <h3>Your Order</h3>
        <div id="order-items"></div>
        
        <div class="order-summary">
          <div>Subtotal: <span id="subtotal">‚Ç±0.00</span></div>
          <div>Shipping: <span id="shipping-fee">May vary</span></div>
          <hr />
          <div class="total">Total: <span id="total">‚Ç±0.00</span></div>
        </div>
      </aside>
    </div>

    <section class="bracelet-preview-section">
      <h2 class="bracelet-preview-section">Your Customized Bracelet Preview</h2>
      <div class="bracelet-preview-wrapper" id="bracelet-preview-wrapper" style="display:none;">
        <img id="bracelet-preview-img" alt="Bracelet Preview">
      </div>
    </section>
  </main>

  <footer class="footer">
    <p>¬© 2025 D'lia Ornaments PH | All Rights Reserved.</p>
  </footer>

  <div id="receipt-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content receipt-modal"></div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const fmt = n => "‚Ç±" + n.toFixed(2);

    // --- 1. Load Info ---
    const info = JSON.parse(localStorage.getItem("checkoutInfo") || "{}");
    document.getElementById("contact-email").textContent = info.email || "your@email.com";
    document.getElementById("shipping-address").textContent =
      `${info.address || ""}, ${info.postal || ""} ${info.city || ""}, ${info.region || ""}`;

    // --- 2. Bracelet Preview Logic ---
    const previewUrl = localStorage.getItem("braceletPreviewImage");
    const wrapper = document.getElementById("bracelet-preview-wrapper");
    const img = document.getElementById("bracelet-preview-img");
    if (previewUrl) {
      img.src = previewUrl;
      wrapper.style.display = "block";
    }

    // --- 3. Build Receipt Data ---
    function buildReceipt() {
      const cart = JSON.parse(localStorage.getItem("cartItems") || "[]");
      const braceletColor = localStorage.getItem("braceletColor");
      const braceletSize = localStorage.getItem("braceletSize") || "Medium";

      const shippingRaw = localStorage.getItem("shippingMethod") || "standard";
      const shippingDisplay = shippingRaw === "same-day" ? "üõµ Same Day Delivery" : "üöö Standard Shipping";

      const now = new Date();
      const manila = new Intl.DateTimeFormat('en-PH', {
        timeZone: 'Asia/Manila', year:'numeric', month:'short', day:'numeric',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      }).format(now);

      const items = [];
      let subtotal = 0;

      if (braceletColor) {
        const prices = {
          silver: { Small: 240, Medium: 255, Large: 270, "Extra Large": 285, "Extra Extra Large": 300 },
          gold: { Small: 400, Medium: 425, Large: 450, "Extra Large": 475, "Extra Extra Large": 500 },
          mixed: { Small: 480, Medium: 510, Large: 540, "Extra Large": 570, "Extra Extra Large": 600 }
        };
        let key = "silver";
        const rc = braceletColor.toLowerCase();
        if (rc.includes("gold") && !rc.includes("mixed")) key = "gold";
        else if (rc.includes("mixed")) key = "mixed";
        const bprice = prices[key]?.[braceletSize] || 0;
        
        items.push({ 
            name: `${braceletColor.charAt(0).toUpperCase() + braceletColor.slice(1)} Bracelet (${braceletSize})`, 
            qty: 1, 
            price: bprice,
            img: `assets/bracelets/${key}.png`
        });
        subtotal += bprice;
      }

      cart.forEach(i => {
        const qty = i.quantity || 1;
        const price = (i.price || 0) * qty;
        items.push({ name: i.name, qty, price, img: i.img });
        subtotal += price;
      });

      return { info, items, total: subtotal, datetime: manila, shipping: shippingDisplay };
    }

    // --- 4. RENDER SIDEBAR ---
    const sidebarData = buildReceipt();
    const orderItemsContainer = document.getElementById('order-items');
    
    orderItemsContainer.innerHTML = sidebarData.items.map(item => `
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; font-size: 0.9rem;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 50px; height: 50px; background: #eee; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; flex-shrink:0;">
                    <img src="${item.img}" style="width:100%; height:100%; object-fit: cover;">
                </div>
                <div>
                    <div style="font-weight: 500; color: #333;">${item.name}</div>
                    <div style="font-size: 0.8em; color: #888;">Qty: ${item.qty}</div>
                </div>
            </div>
            <div style="font-weight: 600; color: #2b0f0f;">${fmt(item.price)}</div>
        </div>
    `).join('');

    document.getElementById('subtotal').textContent = fmt(sidebarData.total);
    document.getElementById('total').textContent = fmt(sidebarData.total);

    // --- 5. Show Receipt Modal ---
    const modal = document.getElementById("receipt-modal");

    function showReceiptModal() {
      const r = buildReceipt(); 
      modal.innerHTML = `
        <div class="modal-content receipt-modal" style="width: 90%; max-width: 440px; text-align: left; max-height: 90vh; overflow-y: auto; background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative;">
          
          <div id="capture-receipt" style="background: white; padding: 30px 30px 10px; color: #2b0f0f; font-family: 'Poppins', sans-serif;">
              <header style="text-align: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: #690d0d; font-size: 1.5rem; font-weight: 700;">üéâ Order Confirmed</h2>
                <div style="font-size: 0.85rem; color: #888; margin-top: 5px;">D‚Äôlia Ornaments PH ‚Äî Official Receipt</div>
              </header>
              
              <table style="width: 100%; font-size: 0.9rem; color: #444; background: #fdfdfd; border: 1px solid #eee; border-radius: 8px; border-collapse: separate; border-spacing: 10px;">
                <tr>
                  <td style="font-weight: 700; width: 90px; vertical-align: top;">Email:</td>
                  <td style="color: #555; word-break: break-all;">${r.info.email || '‚Äî'}</td>
                </tr>
                <tr>
                  <td style="font-weight: 700; vertical-align: top;">Address:</td>
                  <td style="color: #555; line-height: 1.4;">${r.info.address || ''}</td>
                </tr>
                <tr>
                  <td style="font-weight: 700; vertical-align: top;">Shipping:</td>
                  <td style="color: #555;">${r.shipping}</td>
                </tr>
                <tr>
                  <td style="font-weight: 700; vertical-align: top;">Date:</td>
                  <td style="color: #555;">${r.datetime}</td>
                </tr>
              </table>
              
              <hr style="border: 0; border-top: 1px dashed #ccc; margin: 20px 0;"/>

              <div id="receipt-items-list" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                  ${r.items.map(it => `
                    <tr>
                      <td style="padding: 10px 0; vertical-align: middle;">
                        <div style="display:flex; align-items:center; gap:12px;">
                          <img src="${it.img}" style="width:45px; height:45px; border-radius:6px; border:1px solid #eee; background:#f9f9f9; object-fit:contain;">
                          <div>
                             <div style="font-weight: 600; color:#333;">${it.name}</div>
                             <div style="font-size:0.85em; color:#777;">Qty: ${it.qty}</div>
                          </div>
                        </div>
                      </td>
                      <td style="padding: 10px 0; vertical-align: middle; text-align: right; font-weight: 700; color: #000; width: 100px;">
                        ${fmt(it.price)}
                      </td>
                    </tr>
                  `).join('')}
                </table>
              </div>

              <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 2px solid #690d0d;">
                <span style="font-weight: 600; font-size: 1.1rem; color: #690d0d;">Total</span>
                <span style="font-weight: 800; font-size: 1.4rem; color: #2b0f0f;">${fmt(r.total)}</span>
              </div>
          </div>

          <section style="padding: 0 25px 25px; flex-shrink: 0; background: #fff;">
            <button id="download-receipt-btn" class="confirm-btn" style="width: 100%; background: #444; margin-bottom: 20px; font-weight: 600; padding: 12px; border: none; border-radius: 6px; color: white; cursor: pointer;">
              <i class="fas fa-download"></i> Download Receipt Image
            </button>

            <div style="background: #fff9f0; padding: 15px; border-radius: 10px; border: 1px solid #faead1; text-align: center;">
              <p style="margin: 0 0 12px; font-weight: 700; color: #d4af37; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;">Next Steps:</p>
              <p style="font-size: 0.85rem; color: #555; margin-bottom: 15px; line-height: 1.4;">
                Message us on our social media with <b>this receipt</b>, your <b>bracelet preview</b>, and <b>proof of payment</b>.
              </p>
              
              <div style="display: flex; justify-content: center; gap: 25px; font-size: 1.6rem;">
                <a href="https://www.facebook.com/profile.php?id=100086048326178" target="_blank" style="color: #1877f2;"><i class="fab fa-facebook"></i></a>
                <a href="https://instagram.com/dliaornamentsph" target="_blank" style="color: #e4405f;"><i class="fab fa-instagram"></i></a>
                <a href="https://www.tiktok.com/@dliaornamentsph" target="_blank" style="color: #000;"><i class="fab fa-tiktok"></i></a>
              </div>
            </div>

            <button id="close-modal" class="confirm-btn" style="margin-top: 20px; width: 100%; border-radius: 6px; cursor: pointer;">Close & Return Home</button>
          </section>
        </div>
      `;
      
      modal.style.display = 'flex';

      // Download Receipt Logic
      modal.querySelector("#download-receipt-btn").addEventListener("click", async () => {
        const btn = modal.querySelector("#download-receipt-btn");
        const list = modal.querySelector("#receipt-items-list");
        const captureArea = modal.querySelector("#capture-receipt");
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        
        // Expand list to full height for screenshot
        const originalMaxHeight = list.style.maxHeight;
        const originalOverflow = list.style.overflowY;
        list.style.maxHeight = "none";
        list.style.overflowY = "visible";
        
        try {
            const canvas = await html2canvas(captureArea, {
                scale: 3, 
                useCORS: true,
                backgroundColor: "#ffffff",
                logging: false,
                onclone: (clonedDoc) => {
                    clonedDoc.getElementById("receipt-items-list").style.maxHeight = "none";
                }
            });
            
            const link = document.createElement('a');
            link.download = `Dlia-Receipt-${Date.now()}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        } catch (e) {
            alert("Download failed. Please take a screenshot.");
        } finally {
            // Restore list style
            list.style.maxHeight = originalMaxHeight;
            list.style.overflowY = originalOverflow;
            btn.innerHTML = '<i class="fas fa-download"></i> Download Receipt Image';
        }
      });

      // Close Logic
      modal.querySelector("#close-modal").addEventListener("click", () => {
        localStorage.clear();
        window.location.href = 'index.html';
      });
    }

    // --- 6. Form Submission ---
    const paymentForm = document.getElementById("payment-form");
    
    paymentForm.addEventListener("submit", (e) => {
      e.preventDefault();
      
      const confirmBtn = paymentForm.querySelector('.confirm-btn');
      const originalText = confirmBtn.textContent;
      confirmBtn.textContent = "Processing Order...";
      confirmBtn.disabled = true;

      const receipt = buildReceipt();
      const paymentMethod = document.querySelector("input[name='payment']:checked").value;

      // HTML Summary for Email
      const orderSummaryString = receipt.items.map(item => `
          <tr>
            <td style="padding: 8px 0; border-bottom: 1px solid #eee; color: #444;">
              ${item.name} <span style="color: #999; font-size: 12px;">(x${item.qty})</span>
            </td>
            <td style="padding: 8px 0; border-bottom: 1px solid #eee; text-align: right; color: #2b0f0f; font-weight: 500;">
              ${fmt(item.price)}
            </td>
          </tr>
      `).join('');

      const templateParams = {
        customer_name: receipt.info.fullname,
        customer_email: receipt.info.email,
        phone_number: receipt.info.phone,
        customer_address: `${receipt.info.address}, ${receipt.info.city}`,
        payment_method: paymentMethod,
        shipping_method: receipt.shipping,
        order_summary: orderSummaryString,
        total_price: fmt(receipt.total)
      };

      // ‚ö†Ô∏è Use your actual IDs from EmailJS
      const serviceID = 'service_xx3u32v';      
      const merchantTemplate = 'template_merchant';
      const customerTemplate = 'template_customer';

      Promise.all([
        emailjs.send(serviceID, merchantTemplate, templateParams),
        emailjs.send(serviceID, customerTemplate, templateParams)
      ])
      .then(() => {
        confirmBtn.textContent = originalText;
        confirmBtn.disabled = false;
        showReceiptModal(); 
      })
      .catch(err => {
        console.error('Email failed:', err);
        alert('Order processed, but email confirmation failed.');
        confirmBtn.textContent = originalText;
        confirmBtn.disabled = false;
        showReceiptModal(); 
      });
    });
  });
  </script>

  <div id="qr-modal" class="qr-modal-overlay">
    <div class="qr-modal-content">
      <h3 class="qr-title" id="qr-title">Scan to Pay</h3>
      <p class="qr-subtitle" id="qr-subtitle">Use your app to scan this code</p>
      
      <img id="qr-image" src="" alt="Payment QR Code" class="qr-image">
      
      <button class="close-qr" onclick="closeQR()">Close</button>
    </div>
  </div>

  <script>
    // === QR Pop-up Logic ===
    const qrImages = {
      gcash: "assets/payment/gcash-qr.jpg", 
      maya: "assets/payment/maya-qr.jpg"
    };

    function openQR(type, event) {
      if(event) {
        event.preventDefault();
        event.stopPropagation();
      }

      const modal = document.getElementById('qr-modal');
      const img = document.getElementById('qr-image');
      const title = document.getElementById('qr-title');

      if (type === 'gcash') {
        title.textContent = "GCash QR Code";
        img.src = qrImages.gcash;
      } else if (type === 'maya') {
        title.textContent = "Maya QR Code";
        img.src = qrImages.maya;
      }

      modal.style.display = 'flex';
    }

    function closeQR() {
      document.getElementById('qr-modal').style.display = 'none';
    }

    document.getElementById('qr-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeQR();
      }
    });
  </script>
</body>
</html>